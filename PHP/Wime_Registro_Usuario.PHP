<?php
// ğŸ” Mostrar errores (quitar en producciÃ³n)
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// ğŸ“¦ Datos de conexiÃ³n
$servidor = "localhost";
$usuario = "root";
$clave = "";
$baseDatos = "wime";

$conn = new mysqli("localhost", "root", "", "wime");

if ($conn->connect_error) {
    die("ConexiÃ³n fallida: " . $conn->connect_error);
}


// ğŸ”Œ ConexiÃ³n a la base de datos
$conexion = mysqli_connect($servidor, $usuario, $clave, $baseDatos);
if (!$conexion) {
    die("âŒ Error de conexiÃ³n: " . mysqli_connect_error());
}

// âœ… Verificar si se enviÃ³ el formulario por POST
if ($_SERVER["REQUEST_METHOD"] == "POST") {

    // ğŸ“¥ RecolecciÃ³n de datos del formulario
    $EmailUsuario = isset($_POST["EmailUsuario"]) ? trim($_POST["EmailUsuario"]) : "";
    $NombreUsuario    = trim($_POST["NombreUsuario"]    ?? '');
    $Contrasena       = trim($_POST["ContrasenaUsuario"]?? '');
    $Confirmar        = trim($_POST["confirm_password"] ?? '');
    $Edad             = trim($_POST["Birth_Day"]        ?? '');
    $fechaRegistro    = date('Y-m-d H:i:s');


    // âš ï¸ Validaciones
    if (empty($EmailUsuario) || empty($NombreUsuario) || empty($Contrasena) || empty($Confirmar) || empty($Edad)) {
        die("âŒ Error: Todos los campos son obligatorios.");
    }

    if ($Contrasena !== $Confirmar) {
        die("âŒ Error: Las contraseÃ±as no coinciden.");
    }

    // ğŸ” Encriptar contraseÃ±a
    $ContrasenaEncriptada = password_hash($Contrasena, PASSWORD_DEFAULT);



    $email = trim($_POST["EmailUsuario"]);
    $query = "SELECT * FROM usuario WHERE EmailUsuario = ?";
    $stmt = $conn->prepare($query);
    $stmt->bind_param("s", $EmailUsuario);
    $stmt->execute();
    $result = $stmt->get_result();

    if ($result->num_rows > 0) {
        // Ya existe el correo
        echo "<div class='alert alert-warning'>Este correo ya estÃ¡ registrado, Â¿desea <a href='login.php'>iniciar sesiÃ³n</a>?</div>";
        exit(); // Detiene el script para que no siga intentando registrar
    }




    // ğŸ§¾ Preparar consulta segura
    $stmt = $conexion->prepare("INSERT INTO usuario (EmailUsuario, NombreUsuario, ContraseÃ±aUsiario, Edad, FechaRegistro) VALUES (?, ?, ?, ?, ?)");
    $stmt->bind_param("sssss", $EmailUsuario, $NombreUsuario, $ContrasenaEncriptada, $Edad, $fechaRegistro);
    

    // âœ… Ejecutar consulta
    if ($stmt->execute()) {
        echo "âœ… Registro exitoso.";
    } else {
        echo "âŒ Error en el registro: " . $stmt->error;
    }

    // ğŸ§¹ Cierre
    $stmt->close();
    $conexion->close();

} else {
    die("âŒ Error: Acceso no permitido.");
}




?>
